<!DOCTYPE html>
<html lang="th">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Home 297</title>
    <style>
        /* -------------------- Layout -------------------- */
        div.main {
            text-align: center;
            border: 1px solid blue;
            border-radius: 20px;
            margin: 5%;
            bottom: 100px;
        }

        div.main2,
        div.main3,
        div.main4,
        div.main5,
        div.main6,
        div.main7 {
            text-align: center;
            width: 99%;
            height: 52px;
            border: 1px solid green;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        div.main2 {
            background: linear-gradient(to left, green -50%, white 80%);
        }

        div.main3 {
            background: linear-gradient(to left, brown -50%, white 80%);
        }

        div.main4 {
            background: linear-gradient(to left, blue -50%, white 80%);
        }

        div.main5 {
            background: linear-gradient(to left, red -50%, white 80%);
        }

        div.main6 {
            background: linear-gradient(to left, rgb(248, 1, 195) -50%, white 80%);
        }

        div.main7 {
            background: linear-gradient(to left, rgb(42, 1, 248) -50%, white 80%);
        }

        .btn2 {
            display: inline-block;
            height: 36px;
            width: 23%;
            min-width: 36px;
            border-radius: 30px;
            background: #04AA6D;
            border: 1px solid #04AA6D;
            margin: 10px 1px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            position: relative;
        }

        .btn2:disabled {
            background: #767474;
            border: 1px solid #767474;
            color: #000;
            cursor: default;
        }

        .lbl {
            display: inline-block;
            height: 40px;
            width: 23%;
            min-width: 100px;
            text-align: right;
            position: relative;
        }

        /* -------------------- Popup -------------------- */
        .popup {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .popup-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 15px #000;
        }

        .popup-content input[type=text],
        .popup-content input[type=password] {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            border: 1px solid #aaa;
            text-align: center;
            font-size: 16px;
        }

        .popup-content button {
            width: 50%;
            padding: 10px;
            background-color: #04AA6D;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .popup-content button:hover {
            background-color: #037a4a;
        }
    </style>

    <script>
        const pins = [14, 26, 17, 18, 19, 22, 4, 23, 5, 27, 33];
        let ws;

        // -------------------- On Load --------------------
        window.onload = () => {
            const token = localStorage.getItem("authToken");
            if (token) {
                document.getElementById("loginPopup").style.display = "none";
                initWebSocket();
            } else {
                document.getElementById("loginPopup").style.display = "block";
            }
        };

        // -------------------- Login --------------------
        async function doLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            console.log('username Data: ', username);
            console.log('password Data: ', password);
            try {
                const res = await fetch('http://127.0.0.1:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('authToken', data.token);
                    document.getElementById('loginPopup').style.display = 'none';
                    alert('Login successful!');
                    initWebSocket();
                } else {
                    document.getElementById('loginError').innerText = data.error || 'Login failed';
                }
            } catch (err) {
                document.getElementById('loginError').innerText = 'Network error';
            }
        }

        // -------------------- Toggle Pins --------------------
        async function toggle(pin, state) {
            const token = localStorage.getItem('authToken');
            if (!token) { alert("Please login first"); return; }

            const deviceId = "esp32_01"; // example device id
            try {
                const res = await fetch(`http://localhost:3000/device/${deviceId}/state`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ pin, state })
                });
                const data = await res.json();
                if (!res.ok) alert(data.error || "Failed");
            } catch (err) { alert("Network error"); }
        }

        // -------------------- WebSocket --------------------
        function initWebSocket() {
            const token = localStorage.getItem("authToken");
            ws = new WebSocket(`ws://localhost:3000/ws?token=${token}`);
            ws.onopen = () => console.log("WebSocket connected");
            ws.onmessage = e => console.log("Message:", e.data);
        }
    </script>

</head>

<body>
    <!-- -------------------- Login Popup -------------------- -->
    <div id="loginPopup" class="popup">
        <div class="popup-content">
            <h2>เข้าสู่ระบบ Smart Home</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <div id="loginError" style="color:red; font-size:14px;"></div>
            <button onclick="doLogin()">Login</button>
        </div>
    </div>

    <!-- -------------------- Main UI -------------------- -->
    <form onsubmit="return false;">
        <div class="main">
            <h2><label style="color:#12590D;">&#128161; Smart Home Control &#128161;</label></h2>

            <div class="main3"><label class="lbl">&#3588;&#3619;&#3633;&#3623;&#9312;</label>
                <button class="btn2" onclick="toggle(5,true)">On</button>
                <button class="btn2" onclick="toggle(5,false)">Off</button>
            </div>
            <div class="main3"><label class="lbl">&#3588;&#3619;&#3633;&#3623;&#9313;</label>
                <button class="btn2" onclick="toggle(26,true)">On</button>
                <button class="btn2" onclick="toggle(26,false)">Off</button>
            </div>
            <div class="main3"><label class="lbl">&#3588;&#3619;&#3633;&#3623;&#9314;</label>
                <button class="btn2" onclick="toggle(17,true)">On</button>
                <button class="btn2" onclick="toggle(17,false)">Off</button>
            </div>

            <div style="margin-top:20px;">
                <a href="/wifi" style="color:#777; font-size:14px; text-decoration:none;">Reset WiFi &#128246;</a>
            </div>
        </div>
    </form>
</body>

</html>