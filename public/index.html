<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡πá‡∏ï</title>
    <style>
        /* --- ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ UI ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á/‡∏•‡πâ‡∏ô‡∏à‡∏≠ --- */
        * { box-sizing: border-box; } 

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding: 20px; 
            color: #333; 
        }
        
        #container { 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }

        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; margin-top: 0; }
        h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; color: #555; font-size: 1.1em; text-align: center; }
        
        .row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid #f0f0f0; 
        }
        
        .label { 
            flex-grow: 1; 
            font-size: 16px; 
            font-weight: 500;
            padding-right: 10px; 
        }

        .btn { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 20px; 
            color: white; 
            cursor: pointer; 
            font-size: 14px; 
            margin-left: 5px; 
            min-width: 60px;
            transition: all 0.2s;
            flex-shrink: 0; 
        }

        .on { background: #4CAF50; box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3); }
        .on:hover { background: #45a049; }
        
        .off { background: #9e9e9e; }
        .off:hover { background: #757575; }

        /* Login Modal */
        #loginModal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }

        #loginBox { 
            background: white; padding: 30px; width: 90%; max-width: 320px; 
            border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; 
        }

        #loginBox input { 
            width: 100%; padding: 12px; margin-top: 10px; 
            border-radius: 8px; border: 1px solid #ddd; font-size: 16px; 
        }

        #loginBox button { 
            width: 100%; padding: 12px; margin-top: 20px; 
            border: none; border-radius: 8px; background: #2196F3; 
            color: white; font-size: 16px; cursor: pointer; font-weight: bold;
        }

        /* Menu Area (‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á) */
        .menu-area {
            text-align: center; 
            margin-top: 30px; 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
        }

        .btn-menu {
            text-decoration: none; 
            padding: 10px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.3s;
            border: none;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-schedule { background: #2196F3; }
        .btn-schedule:hover { background: #1976D2; }

        .btn-logout { background: #ff5252; }
        .btn-logout:hover { background: #d32f2f; }

    </style>
</head>
<body>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Login -->
    <div id="loginModal">
        <div id="loginBox">
            <h3>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <input type="text" id="username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <!-- ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å -->
    <div id="container">
        <h2>üè† Smart Home Control</h2>
        
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° ESP32 (‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô) -->
        <div id="controls-esp32" style="text-align:center; color:#888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° ESP8266 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
        <div id="controls-esp8266"></div>

        <!-- ‡πÄ‡∏°‡∏ô‡∏π (‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ + Logout) -->
        <div class="menu-area">
            <a href="/schedule.html" class="btn-menu btn-schedule">‚è∞ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤</a>
            <button id="btnLogout" class="btn-menu btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <script>
        const API_URL = "/api";
        let token = localStorage.getItem("token");

        // Config ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        const devices = {
            "esp32-01": {
                containerId: "controls-esp32",
                labels: ["‡∏Ñ‡∏£‡∏±‡∏ß 1", "‡∏Ñ‡∏£‡∏±‡∏ß 2", "‡∏Ñ‡∏£‡∏±‡∏ß 3", "‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡πå‡∏°‡∏µ‡πà", "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏°‡πÄ‡∏ó‡∏û", "‡∏´‡πâ‡∏≠‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà", "‡πÑ‡∏ü‡∏£‡∏∞‡∏¢‡πâ‡∏≤ 1", "‡πÑ‡∏ü‡∏£‡∏∞‡∏¢‡πâ‡∏≤ 2", "‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô", "‡πÑ‡∏ü‡πÅ‡∏™‡∏á‡∏™‡∏µ (Alarm)", "‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤"],
                state: 0 
            },
            "esp8266-01": {
                containerId: "controls-esp8266",
                labels: ["‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÇ‡∏£‡∏á‡∏£‡∏ñ", "‡πÑ‡∏ü‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô"], 
                state: 0
            }
        };

        function showLogin() {
            document.getElementById("loginModal").style.display = "flex";
        }

        function login() {
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();

            fetch(`${API_URL}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
            .then(r => r.json())
            .then(res => {
                if (res.token) {
                    localStorage.setItem("token", res.token);
                    token = res.token;

                    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏Å‡∏∞ Role ‡∏à‡∏≤‡∏Å Token ---
                    try {
                        const payload = JSON.parse(atob(res.token.split('.')[1]));
                        localStorage.setItem("role", payload.role);
                    } catch (e) { console.error(e); }
                    // ----------------------------------

                    document.getElementById("loginModal").style.display = "none";
                    loadAll(); 
                } else {
                    alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (res.error || "Unknown"));
                }
            })
            .catch(err => {
                console.error(err);
                alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
            });
        }

        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("role"); // ‡∏•‡∏ö Role ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢
            location.reload();
        }

        function buildUI() {
            for (const [devId, config] of Object.entries(devices)) {
                const area = document.getElementById(config.containerId);
                // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô config ‡∏°‡∏µ‡πÅ‡∏ï‡πà html ‡πÑ‡∏°‡πà‡∏°‡∏µ) ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
                if (!area) continue; 
                
                area.innerHTML = "";
                
                // ‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                if(devId === "esp8266-01") area.innerHTML += `<h3>‡πÇ‡∏£‡∏á‡∏£‡∏ñ & ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô</h3>`;
                else if(devId === "esp32-01") area.innerHTML += `<h3>‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</h3>`;

                config.labels.forEach((label, index) => {
                    const mask = 1 << index;
                    const isOn = (config.state & mask) !== 0;

                    area.innerHTML += `
                    <div class="row">
                        <div class="label">${label}</div>
                        <button class="btn ${!isOn ? 'on' : 'off'}" onclick="togglePin('${devId}', ${index}, true)">‡πÄ‡∏õ‡∏¥‡∏î</button>
                        <button class="btn ${isOn ? 'on' : 'off'}" onclick="togglePin('${devId}', ${index}, false)">‡∏õ‡∏¥‡∏î</button>
                    </div>`;
                });
            }
        }

        async function loadState(devId) {
            try {
                const r = await fetch(`${API_URL}/device/${devId}/getState`, {
                    headers: { "authorization": "Bearer " + token }
                });

                if (r.status === 401 || r.status === 403) {
                    showLogin();
                    return;
                }
                const buf = new Uint8Array(await r.arrayBuffer());
                if (buf.length === 2) {
                    devices[devId].state = (buf[0] << 8) | buf[1];
                }
            } catch (e) {
                console.error(`Error loading ${devId}:`, e);
            }
        }

        async function loadAll() {
            for (const devId of Object.keys(devices)) {
                await loadState(devId);
            }
            buildUI();
        }

        async function togglePin(devId, index, turnOn) {
            let currentMask = devices[devId].state;
            const mask = 1 << index;

            if (turnOn) currentMask |= mask; 
            else currentMask &= ~mask;

            // UI Optimistic Update
            devices[devId].state = currentMask;
            buildUI();

            const buf = new Uint8Array(2);
            buf[0] = (currentMask >> 8) & 0xFF;
            buf[1] = currentMask & 0xFF;

            try {
                await fetch(`${API_URL}/device/${devId}/setState`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/octet-stream",
                        "Authorization": "Bearer " + token
                    },
                    body: buf
                });
            } catch (err) {
                console.error("Fetch error:", err);
                alert("‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                loadAll();
            }
        }

        window.onload = () => {
            if (!token) {
                showLogin();
            } else {
                loadAll();
            }
            
            setInterval(() => { 
                if(token && document.getElementById("loginModal").style.display === "none") {
                    loadAll(); 
                }
            }, 3000);
        };
    </script>
</body>
</html>
