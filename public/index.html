<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡πá‡∏ï</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        
        #container { 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }

        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; color: #555; font-size: 1.1em; }
        
        .row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid #f0f0f0; 
        }
        
        .label { 
            flex-grow: 1; 
            font-size: 16px; 
            font-weight: 500;
        }

        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 20px; 
            color: white; 
            cursor: pointer; 
            font-size: 14px; 
            margin-left: 8px; 
            min-width: 60px;
            transition: all 0.2s;
            width:25%;
        }

        .on { background: #4CAF50; box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3); }
        .on:hover { background: #45a049; }
        
        .off { background: #9e9e9e; }
        .off:hover { background: #757575; }

        /* Login Modal */
        #loginModal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }

        #loginBox { 
            background: white; padding: 30px; width: 90%; max-width: 320px; 
            border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; 
        }

        #loginBox input { 
            width: 100%; padding: 12px; margin-top: 10px; box-sizing: border-box;
            border-radius: 8px; border: 1px solid #ddd; font-size: 16px; 
        }

        #loginBox button { 
            width: 100%; padding: 12px; margin-top: 20px; 
            border: none; border-radius: 8px; background: #2196F3; 
            color: white; font-size: 16px; cursor: pointer; font-weight: bold;
        }

        #btnLogout {
            background: #ff5252; color: white; border: none; 
            padding: 10px 20px; border-radius: 8px; cursor: pointer; 
            font-size: 14px; margin-top: 20px; transition: background 0.3s;
        }
        #btnLogout:hover { background: #d32f2f; }

    </style>
</head>
<body>
    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Login -->
    <div id="loginModal">
        <div id="loginBox">
            <h3>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <input type="text" id="username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button onclick="login()">Login</button>
        </div>
    </div>

    <!-- ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å -->
    <div id="container">
        <h2>üè† Smart Home Control</h2>
        
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° ESP32 (‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô) -->
        <!-- <h3>‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô (ESP32)</h3> -->
        <div id="controls-esp32" style="text-align:center; color:#888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° ESP8266 (‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô) -->
        <!-- <h3>‡πÇ‡∏£‡∏á‡∏£‡∏ñ & ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (ESP8266)</h3> -->
        <div id="controls-esp8266" style="text-align:center; color:#888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

        <div style="text-align:center;">
            <button id="btnLogout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <script>
        const API_URL = "/api";
        let token = localStorage.getItem("token");

        // Config ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        const devices = {
            "esp32-01": {
                containerId: "controls-esp32",
                labels: ["‡∏Ñ‡∏£‡∏±‡∏ß 1", "‡∏Ñ‡∏£‡∏±‡∏ß 2", "‡∏Ñ‡∏£‡∏±‡∏ß 3", "‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡πå‡∏°‡∏µ‡πà", "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡πá‡∏°‡πÄ‡∏ó‡∏û", "‡∏´‡πâ‡∏≠‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà", "‡πÑ‡∏ü‡∏£‡∏∞‡∏¢‡πâ‡∏≤ 1", "‡πÑ‡∏ü‡∏£‡∏∞‡∏¢‡πâ‡∏≤ 2", "‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô", "‡πÑ‡∏ü‡πÅ‡∏™‡∏á‡∏™‡∏µ", "‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤"],
                state: 0 // ‡πÄ‡∏Å‡πá‡∏ö bitmask ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            },
            "esp8266-01": {
                containerId: "controls-esp8266",
                labels: ["‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÇ‡∏£‡∏á‡∏£‡∏ñ", "‡πÑ‡∏ü‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô"], // Index 0=D6, Index 1=D5
                state: 0
            }
        };

        function showLogin() {
            document.getElementById("loginModal").style.display = "flex";
        }

        function login() {
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();

            fetch(`${API_URL}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
            .then(r => r.json())
            .then(res => {
                if (res.token) {
                    localStorage.setItem("token", res.token);
                    token = res.token;
                    document.getElementById("loginModal").style.display = "none";
                    
                    // *** ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadAll() ‡πÅ‡∏ó‡∏ô loadState() ‡πÄ‡∏â‡∏¢‡πÜ ***
                    loadAll(); 
                } else {
                    alert("Login failed: " + (res.error || "Unknown"));
                }
            })
            .catch(err => {
                console.error(err);
                alert("Connection Error");
            });
        }

        function logout() {
            localStorage.removeItem("token");
            location.reload();
        }

        function buildUI() {
            for (const [devId, config] of Object.entries(devices)) {
                const area = document.getElementById(config.containerId);
                // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠ id ‡∏ú‡∏¥‡∏î) ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
                if (!area) continue; 
                
                area.innerHTML = "";
                
                config.labels.forEach((label, index) => {
                    const mask = 1 << index;
                    const isOn = (config.state & mask) !== 0;

                    area.innerHTML += `
                    <div class="row">
                        <div class="label">${label}</div>
                        <button class="btn ${!isOn ? 'on' : 'off'}" onclick="togglePin('${devId}', ${index}, true)">‡πÄ‡∏õ‡∏¥‡∏î</button>
                        <button class="btn ${isOn ? 'on' : 'off'}" onclick="togglePin('${devId}', ${index}, false)">‡∏õ‡∏¥‡∏î</button>
                    </div>`;
                });
            }
        }

        async function loadState(devId) {
            try {
                const r = await fetch(`${API_URL}/device/${devId}/getState`, {
                    headers: { "authorization": "Bearer " + token }
                });

                if (r.status === 401 || r.status === 403) {
                    showLogin();
                    return;
                }
                const buf = new Uint8Array(await r.arrayBuffer());
                if (buf.length === 2) {
                    // ‡πÅ‡∏õ‡∏•‡∏á Buffer ‡πÄ‡∏õ‡πá‡∏ô Integer ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state ‡πÉ‡∏ô config
                    devices[devId].state = (buf[0] << 8) | buf[1];
                }
            } catch (e) {
                console.error(`Error loading ${devId}:`, e);
            }
        }

        async function loadAll() {
            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å Device ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô config
            for (const devId of Object.keys(devices)) {
                await loadState(devId);
            }
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            buildUI();
        }

        async function togglePin(devId, index, turnOn) {
            let currentMask = devices[devId].state;
            const mask = 1 << index;

            if (turnOn) currentMask |= mask; 
            else currentMask &= ~mask;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Optimistic UI)
            devices[devId].state = currentMask;
            buildUI();

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Binary ‡∏™‡πà‡∏á Server
            const buf = new Uint8Array(2);
            buf[0] = (currentMask >> 8) & 0xFF;
            buf[1] = currentMask & 0xFF;

            try {
                await fetch(`${API_URL}/device/${devId}/setState`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/octet-stream",
                        "Authorization": "Bearer " + token
                    },
                    body: buf
                });
            } catch (err) {
                console.error("Fetch error:", err);
                alert("‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
                // ‡∏ñ‡πâ‡∏≤ error ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î state ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á (Optional)
                loadAll();
            }
        } 

        window.onload = () => {
            if (!token) {
                showLogin();
            } else {
                loadAll();
            }
            
            // Auto Refresh ‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á
            setInterval(() => { 
                if(token && document.getElementById("loginModal").style.display === "none") {
                    loadAll(); 
                }
            }, 3000);
        };
    </script>
</body>
</html>