<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡πá‡∏ï</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f3f3f3; margin: 0; padding: 20px; }
        #container { width: 90%; max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 8px rgba(0, 0, 0, 0.15); }
        h2 { text-align: center; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .label { width: 50%; font-size: 16px; }
        .btn { padding: 8px 10px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 14px; margin-left: 5px; width: 22%; }
        .on { background: #4CAF50; }
        .off { background: #888888; }
        /* Login Modal */
        #loginModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; }
        #loginBox { background: white; padding: 20px; width: 300px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); text-align: center; }
        #loginBox input { width: 90%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        #loginBox button { width: 96%; padding: 10px; margin-top: 15px; border: none; border-radius: 6px; background: #4CAF50; color: white; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loginModal">
        <div id="loginBox">
            <h3>Login Smart Home</h3>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="container">
        <h2>üè° ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ü‡∏ö‡πâ‡∏≤‡∏ô</h2>
        <div id="controls">Loading...</div>
        <div style="text-align:center; margin-top:20px;">
            <button id = "btnLogout" onclick="logout()" style="background:#f44336; color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        </div>
    </div>

    <script>
        const pinLabels = [
            "‡∏Ñ‡∏£‡∏±‡∏ß 1", "‡∏Ñ‡∏£‡∏±‡∏ß 2", "‡∏Ñ‡∏£‡∏±‡∏ß 3", 
            "‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡πå‡∏°‡∏°‡∏µ‡πà", "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏∑‡πâ‡∏≠‡∏°‡πÄ‡∏ó‡∏û", "‡∏´‡πâ‡∏≠‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà", 
            "‡πÑ‡∏ü‡∏£‡∏∞‡∏¢‡πâ‡∏≤ 1", "‡πÑ‡∏ü‡∏£‡∏∞‡∏¢‡πâ‡∏≤ 2", "‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô", 
            "‡πÑ‡∏ü‡πÅ‡∏™‡∏á‡∏™‡∏µ (Alarm)", "‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤"
        ];
        const pins = [5, 26, 17, 18, 19, 22, 4, 23, 14, 27, 33];
        const deviceID = "esp32-01";
        let bitmask = 0;
        let token = localStorage.getItem("token");

        // --- URL ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Relative Path ---
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà http://... ‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const API_URL = "/api"; 

        function showLogin() {
            document.getElementById("loginModal").style.display = "flex";
        }

        function login() {
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();

            fetch(`${API_URL}/login`, { // <--- ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
            .then(r => r.json())
            .then(res => {
                if (res.token) {
                    localStorage.setItem("token", res.token);
                    token = res.token;
                    document.getElementById("loginModal").style.display = "none";
                    loadState();
                    
                } else {
                    alert("Login failed: " + (res.error || "Unknown"));
                }
            })
            .catch(err => alert("Connection Error"));
        }

        function logout() {
            localStorage.removeItem("token");
            location.reload();
        }

        function buildUI() {
            const area = document.getElementById("controls");
            area.innerHTML = "";
            pins.forEach((pin, index) => {
                const mask = 1 << index;
                const isOn = (bitmask & mask) !== 0;
                area.innerHTML += `
                    <div class="row">
                        <div class="label">${pinLabels[index]}</div>
                        <button class="btn ${!isOn ? 'on' : 'off'}" onclick="togglePin(${index}, true)">‡πÄ‡∏õ‡∏¥‡∏î</button>
                        <button class="btn ${isOn ? 'on' : 'off'}" onclick="togglePin(${index}, false)">‡∏õ‡∏¥‡∏î</button>
                    </div>`;
            });
            document.getElementById("btnLogout").innerText = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö";
        }

        async function loadState() {
            try {
                const r = await fetch(`${API_URL}/device/${deviceID}/getState`, { // <--- ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    headers: { "authorization": "Bearer " + token }
                });

                if (r.status === 401 || r.status === 403) {
                    showLogin();
                    return;
                }
                const buf = new Uint8Array(await r.arrayBuffer());
                if (buf.length === 2) {
                    bitmask = (buf[0] << 8) | buf[1];
                    buildUI();
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function togglePin(index, turnOn) {
            const mask = 1 << index;
            if (turnOn) bitmask |= mask; else bitmask &= ~mask;

            const buf = new Uint8Array(2);
            buf[0] = (bitmask >> 8) & 0xFF;
            buf[1] = bitmask & 0xFF;

            // Update UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß
            buildUI(); 

            try {
                await fetch(`${API_URL}/device/${deviceID}/setState`, { // <--- ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    method: "POST",
                    headers: {
                        "Content-Type": "application/octet-stream",
                        "Authorization": "Bearer " + token
                    },
                    body: buf
                });
            } catch (err) {
                console.error("Fetch error:", err);
                alert("‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
            }
        }

        window.onload = () => {
            if (!token) showLogin(); else loadState();
            // Auto Refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü)
            setInterval(() => { if(token) loadState(); }, 5000);
        };
    </script>
</body>
</html>